---
import Layout from "../layouts/Layout.astro";
import Container from "../components/Container.astro";
import Link from "../components/Link.astro";
import Pagination from "../components/Pagination.astro";

const GITHUB_TOKEN = import.meta.env.GITHUB_TOKEN;

const PER_PAGE = 100;

const url = new URL(Astro.url);
let currentPage = Number(url.searchParams.get("page") || "1");
if (isNaN(currentPage) || currentPage < 1) {
  return Astro.redirect("/commits?page=1");
}

const API_URL = `https://api.github.com/repos/ibnaleem/shaffan.dev/commits?per_page=${PER_PAGE}&page=${currentPage}`;

const headers: Record<string, string> = {
  Accept: "application/vnd.github+json",
};
if (GITHUB_TOKEN) {
  headers.Authorization = `Bearer ${GITHUB_TOKEN}`;
}

const res = await fetch(API_URL, { headers });
if (!res.ok) {
  throw new Error(`GitHub API error: ${res.status} ${res.statusText}`);
}

const commits = (await res.json()) as GitHubCommit[];

let totalPages = currentPage;
const linkHeader = res.headers.get("link");
if (linkHeader) {
  const lastMatch = linkHeader.match(/<[^>]+page=(\d+)[^>]*>; rel="last"/);
  if (lastMatch) {
    totalPages = Number(lastMatch[1]);
  } else {
    if (linkHeader.includes('rel="next"')) {
      totalPages = currentPage + 1;
    }
  }
}

if (commits.length < PER_PAGE) {
  totalPages = currentPage;
}

type GitHubCommit = {
  sha: string;
  html_url: string;
  author: { login: string; avatar_url: string; html_url: string } | null;
  commit: {
    message: string;
    author: { name: string; date: string };
    committer: { name: string; date: string };
    verification?: { verified: boolean };
  };
};

const formatDateTime = (iso: string) =>
  new Intl.DateTimeFormat("en-GB", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  }).format(new Date(iso));

const firstLine = (msg: string) => (msg.split("\n")[0] ?? "").trim();
const shortSha = (sha: string) => sha.slice(0, 7);

const displayUser = (c: GitHubCommit) =>
  c.author?.login ?? c.commit.author.name ?? "unknown";

const isVerified = (c: GitHubCommit) =>
  Boolean(c.commit.verification?.verified);

const datetime = (c: GitHubCommit) =>
  c.commit.author.date ?? c.commit.committer.date;
---

<Layout title="website commits">
  <Container>
    <article class="space-y-4">
      <ul>
        {commits.map((c) => (
          <li class="flex items-center gap-10 py-2">
            <span class="text-gray-500 text-right whitespace-nowrap tabular-nums w-32">
              {formatDateTime(datetime(c))}
            </span>

            <Link href={`/commits/${c.sha}`}>
              {shortSha(c.sha)}
            </Link>

            <span class="truncate text-gray-200 flex-1 min-w-0">
              {firstLine(c.commit.message)}
            </span>
            
            <span class="text-gray-400">{displayUser(c)}</span>

            {isVerified(c) ? (
              <span class="text-green-400 font-medium">[VERIFIED]</span>
            ) : (
              <span class="text-red-400 font-medium">[UNVERIFIED]</span>
            )}
          </li>
        ))}
      </ul>

      <!-- Pagination -->
      {totalPages > 1 && (
        <Pagination
          previousHref={currentPage > 1 ? `/commits?page=${currentPage - 1}` : undefined}
          nextHref={currentPage < totalPages ? `/commits?page=${currentPage + 1}` : undefined}
          pages={Array.from({ length: Math.min(10, totalPages) }, (_, i) => {
            let pageNum: number;
            if (totalPages <= 10) {
              pageNum = i + 1;
            } else if (currentPage <= 5) {
              pageNum = i + 1;
            } else if (currentPage >= totalPages - 4) {
              pageNum = totalPages - 9 + i;
            } else {
              pageNum = currentPage - 4 + i;
            }
            
            return {
              label: pageNum,
              href: `/commits?page=${pageNum}`,
              active: pageNum === currentPage
            };
          })}
        />
      )}
    </article>
  </Container>
</Layout>